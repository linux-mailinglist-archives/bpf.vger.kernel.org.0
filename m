Return-Path: <bpf-owner@vger.kernel.org>
X-Original-To: lists+bpf@lfdr.de
Delivered-To: lists+bpf@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 9B0DA25A504
	for <lists+bpf@lfdr.de>; Wed,  2 Sep 2020 07:27:13 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726140AbgIBF1M (ORCPT <rfc822;lists+bpf@lfdr.de>);
        Wed, 2 Sep 2020 01:27:12 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:42082 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726021AbgIBF1K (ORCPT <rfc822;bpf@vger.kernel.org>);
        Wed, 2 Sep 2020 01:27:10 -0400
Received: from mail-pf1-x444.google.com (mail-pf1-x444.google.com [IPv6:2607:f8b0:4864:20::444])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 94D13C061244
        for <bpf@vger.kernel.org>; Tue,  1 Sep 2020 22:27:08 -0700 (PDT)
Received: by mail-pf1-x444.google.com with SMTP id u128so2191584pfb.6
        for <bpf@vger.kernel.org>; Tue, 01 Sep 2020 22:27:08 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=date:from:to:cc:message-id:in-reply-to:references:subject
         :mime-version:content-transfer-encoding;
        bh=NxIreLIG3uLmaBkTLod27nbRkYrgU6ImR2GcKCOWWfA=;
        b=UZnvNOBLo4hJZ/pJhIBtTZIrZUWLTZm5Iksdwo1Fnjez4mQ4LvxoA720DV7PJ/Q7lZ
         uEXYi0H5x0WykdaBAbjz8Xu8iMguudP2Ywh4kwT8UpVMMIAb+qGQl33lLwYSUk7LlYL5
         OnLLxSLQfp1rTGt6anWejcCnjRV7LF+JxZFeu8nbK2Ya3AUXypyQSX6D5laPW1sfcH7o
         QIcWjQ0HYkyVi5xaosM3rtnYw+4S//WPFi657+DTL8YnnQovrwOXIjdfccsUcHtsw6Rh
         HAQjYMOF0XPY9DVhcGycNtcmpkTjQxJ4H86+Tgtb4qUn7lC0AamJjzWWf8ropWnnkVPA
         HVWQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:date:from:to:cc:message-id:in-reply-to
         :references:subject:mime-version:content-transfer-encoding;
        bh=NxIreLIG3uLmaBkTLod27nbRkYrgU6ImR2GcKCOWWfA=;
        b=sC/h/ZBLehd9MBkyDNMFVS/BaXawvn6nOEf2Qx0iqKWHlqEturvPvgYHMCUlYTJJi0
         5hp4nJ2MrL1XJHOg2M81VHnQlH15SAuNVNZD+D26b2lYqJXrB7ULUvCM3qdut+m4sUjb
         wV3isFZ2sPA4ME13p4N8S4C1prtnponlAjemQ8G7SeVDbS5HPLfKiTytH+oMtcDBKb15
         ek5aavBS9gEN5s/OfdfiBB+DrJkrbezU9sdWkQJouz1ipCeWsVyQ2bWBwHBfZkL4MkO/
         R2LARfcP20rL+ZTZtumSScYHDnZdSRMBPmwN/kp/UUanp6hfe5iZWl8FNRyMFIWI5dpU
         eRsA==
X-Gm-Message-State: AOAM530f0ymkOxf/I/DJVPpEh5giy3Q+0sbxrt7msU2YBjMZD7GKqpzJ
        oOvFxyqUjUk8JQCTXiMLjPY=
X-Google-Smtp-Source: ABdhPJyGi9Ork/Sl/mQmCsDj/zGsOBgHLsyXhXn3Bhpglp95tQl9lD+4BfnoGi/UA1XRo/g+7jToSg==
X-Received: by 2002:a63:2809:: with SMTP id o9mr654739pgo.410.1599024428086;
        Tue, 01 Sep 2020 22:27:08 -0700 (PDT)
Received: from localhost ([184.63.162.180])
        by smtp.gmail.com with ESMTPSA id ie13sm966067pjb.5.2020.09.01.22.27.05
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 01 Sep 2020 22:27:07 -0700 (PDT)
Date:   Tue, 01 Sep 2020 22:27:00 -0700
From:   John Fastabend <john.fastabend@gmail.com>
To:     Yonghong Song <yhs@fb.com>,
        Andrii Nakryiko <andrii.nakryiko@gmail.com>
Cc:     bpf <bpf@vger.kernel.org>, Alexei Starovoitov <ast@kernel.org>,
        Daniel Borkmann <daniel@iogearbox.net>,
        Kernel Team <kernel-team@fb.com>,
        John Fastabend <john.fastabend@gmail.com>
Message-ID: <5f4f2d24485ac_5f398208c@john-XPS-13-9370.notmuch>
In-Reply-To: <465da51a-793e-5ea0-85dc-56ab4f36ae34@fb.com>
References: <20200825064608.2017878-1-yhs@fb.com>
 <20200825064608.2017937-1-yhs@fb.com>
 <CAEf4Bzb89dz_Sjy14LjQSDWrQ=TpSHAfgf=_Sa=bWUKGqJHCgQ@mail.gmail.com>
 <465da51a-793e-5ea0-85dc-56ab4f36ae34@fb.com>
Subject: Re: [PATCH bpf-next 1/2] bpf: fix a verifier failure with xor
Mime-Version: 1.0
Content-Type: text/plain;
 charset=utf-8
Content-Transfer-Encoding: 7bit
Sender: bpf-owner@vger.kernel.org
Precedence: bulk
List-ID: <bpf.vger.kernel.org>
X-Mailing-List: bpf@vger.kernel.org

Yonghong Song wrote:
> 
> 
> On 9/1/20 1:07 PM, Andrii Nakryiko wrote:
> > On Mon, Aug 24, 2020 at 11:47 PM Yonghong Song <yhs@fb.com> wrote:
> >>
> >> bpf selftest test_progs/test_sk_assign failed with llvm 11 and llvm 12.
> >> Compared to llvm 10, llvm 11 and 12 generates xor instruction which
> > 
> > Does this mean that some perfectly working BPF programs will now fail
> > to verify on older kernels, if compiled with llvm 11 or llvm 12? If
> 
> Right.
> 
> > yes, is there something that one can do to prevent Clang from using
> > xor in such situations?
> 
> The xor is generated by the combination of llvm simplifyCFG and 
> instrCombine phase.

Another option would be to move it out of the isAsCheapAsAMove on the
llvm side. But, probably better to force the workaround until kernels
get support. Even with it being more expensive it wouldn't mean we never
get it so likely not a great idea. Just thought it might be worth
mentioning. If you have your own llvm and don't have these kernels yet
it looks like a win.

> 
> The following is a hack to prevent compiler from generating xor's.
