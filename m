Return-Path: <bpf+bounces-47703-lists+bpf=lfdr.de@vger.kernel.org>
X-Original-To: lists+bpf@lfdr.de
Delivered-To: lists+bpf@lfdr.de
Received: from sv.mirrors.kernel.org (sv.mirrors.kernel.org [IPv6:2604:1380:45e3:2400::1])
	by mail.lfdr.de (Postfix) with ESMTPS id C24439FEA8C
	for <lists+bpf@lfdr.de>; Mon, 30 Dec 2024 21:09:01 +0100 (CET)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by sv.mirrors.kernel.org (Postfix) with ESMTPS id 12E843A2913
	for <lists+bpf@lfdr.de>; Mon, 30 Dec 2024 20:08:57 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 62F49199948;
	Mon, 30 Dec 2024 20:08:52 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=fail reason="signature verification failed" (2048-bit key) header.d=pm.me header.i=@pm.me header.b="iIhmNQ1x"
X-Original-To: bpf@vger.kernel.org
Received: from mail-10629.protonmail.ch (mail-10629.protonmail.ch [79.135.106.29])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 2B28D1990DE
	for <bpf@vger.kernel.org>; Mon, 30 Dec 2024 20:08:49 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=79.135.106.29
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1735589331; cv=none; b=SYH8L6k2Q7dT/OHexkVV7Obu9t1dsC7bkr2VtFksCthwacqLquQGVYX/A/uMib1/Rhqa4KA7+QGmiOrKDN1+XiKInPxJ/rV3UneixfTTFK0xNsEcSbJots62pu9RO07uzVbKtvPH/EGun1nBRxIfdTn4KTfdr11SO03FHhU7uhI=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1735589331; c=relaxed/simple;
	bh=JDYcpWGBojAVYgGMRiG+L91hyhcAlcJIiq9NsWI5YIg=;
	h=Date:To:From:Cc:Subject:Message-ID:MIME-Version:Content-Type; b=O70a+GMN9xvP1uZCHcV29fYpXFTJDz4sd73H/3KEhzlN5jDHlefZqJzfX0cFdjQJAhlaixCeT5U/HpT5YDz+FDmJszJwxT/YDrBBirh3wZTvu6se+wx3icBVEipnDa7r/GuG3NIJzYizcY/Z2azr9gqUnwthLngLVsFP5t6BLLk=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=pm.me; spf=pass smtp.mailfrom=pm.me; dkim=pass (2048-bit key) header.d=pm.me header.i=@pm.me header.b=iIhmNQ1x; arc=none smtp.client-ip=79.135.106.29
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=pm.me
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=pm.me
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=pm.me;
	s=protonmail3; t=1735589322; x=1735848522;
	bh=aVDRanI+SgtG3DMNsh5GmrnX5Z009+u7G6nHdia2g5I=;
	h=Date:To:From:Cc:Subject:Message-ID:Feedback-ID:From:To:Cc:Date:
	 Subject:Reply-To:Feedback-ID:Message-ID:BIMI-Selector:
	 List-Unsubscribe:List-Unsubscribe-Post;
	b=iIhmNQ1x7pWCrhAstHHPlRB8/5rgjE24BsXT1xD5ZWnyxX2qdZpGR2GCxcQm6AilO
	 +3EH9KtCqftQPcWEukJTrTU3zMkNUwxikmnFwGYsRQ4q1WkKZv/42dN6R/lZ1cQp6K
	 0nvSNUHwD+J0Y1J65dtzKVVFTXnp8SMIH9/a2l9swpaV0jOc1IhyyP6UF+HiV6F6EU
	 lkt9SF9q6rCE1L3rWcl1EYYgA5kcVz/hLnkCMDLKDbhgnsqHjBgyoiEvKT4/BgzOBp
	 xRSFDUPjh4vWvQi4TZZTaDkManzFgDy3DQ6Em1xBz2px/M4GmPFCWdIqb280XYC7Cn
	 Hq62NDFSxfQmA==
Date: Mon, 30 Dec 2024 20:08:37 +0000
To: "gcc@gcc.gnu.org" <gcc@gcc.gnu.org>
From: Ihor Solodrai <ihor.solodrai@pm.me>
Cc: Cupertino Miranda <cupertino.miranda@oracle.com>, David Faust <david.faust@oracle.com>, Elena Zannoni <elena.zannoni@oracle.com>, "Jose E. Marchesi" <jose.marchesi@oracle.com>, Alexei Starovoitov <alexei.starovoitov@gmail.com>, Manu Bretelle <chantra@meta.com>, Eduard Zingerman <eddyz87@gmail.com>, Mykola Lysenko <mykolal@meta.com>, Yonghong Song <yonghong.song@linux.dev>, bpf <bpf@vger.kernel.org>
Subject: Errors compiling BPF programs from Linux selftests/bpf with GCC
Message-ID: <ZryncitpWOFICUSCu4HLsMIZ7zOuiH5f4jrgjAh0uiOgKvZzQES09eerwIXNonKEq0U6hdI9pHSCPahUKihTeS8NKlVfkcuiRLotteNbQ9I=@pm.me>
Feedback-ID: 27520582:user:proton
X-Pm-Message-ID: fd7221fbe1e58d3ea423f7ae26b938a351d9a71a
Precedence: bulk
X-Mailing-List: bpf@vger.kernel.org
List-Id: <bpf.vger.kernel.org>
List-Subscribe: <mailto:bpf+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:bpf+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: quoted-printable

Hello everyone.

I picked up the work adding GCC BPF backend to BPF CI pipeline [1],
originally done by Cupertino Miranda [2].

I encountered issues compiling BPF objects for selftests/bpf with
recent GCC 15 snapshots. An additional test runner binary is supposed
to be generated by tools/testing/selftests/bpf/Makefile if BPF_GCC is
set to a directory with GCC binaries for BPF backend. The runner
binary depends on BPF binaries, which are produced by GCC.

The first issue is compilation errors on vmlinux.h:

    In file included from progs/linked_maps1.c:4:
    /ci/workspace/tools/testing/selftests/bpf/tools/include/vmlinux.h:8483:=
9: error: expected identifier before =E2=80=98false=E2=80=99
     8483 |         false =3D 0,
          |         ^~~~~

A snippet from vmlinux.h:

    enum {
    =09false =3D 0,
    =09true =3D 1,
    };

And:

    /ci/workspace/tools/testing/selftests/bpf/tools/include/vmlinux.h:23539=
:15: error: two or more data types in declaration specifiers
    23539 | typedef _Bool bool;
          |               ^~~~

Full log at [3], and also at [4].

You can easily reproduce the errors with a dummy program:

    #include "vmlinux.h"

    int main() {
    =09return 0;
    }

The vmlinux.h is generated from BTF, produced by pahole v1.28 from
DWARF data contained in the vmlinux binary. The vmlinux binary I used
in these experiments is v6.12 (adc218676eef) compiled with gcc 13.3.0
(default Ubuntu installation).

You can download the specific vmlinux.h I tried using a link below [5].

I bisected recent GCC snapshots and determined that the errors related
to the bool declarations started happening on GCC 15-20241117.

Older versions compile the dummy program without errors, however on
attempt to build the selftests there is a different issue: conflicting
int64 definitions (full log at [6]).

    In file included from /usr/include/x86_64-linux-gnu/sys/types.h:155,
                     from /usr/include/x86_64-linux-gnu/bits/socket.h:29,
                     from /usr/include/x86_64-linux-gnu/sys/socket.h:33,
                     from /usr/include/linux/if.h:28,
                     from /usr/include/linux/icmp.h:23,
                     from progs/test_cls_redirect_dynptr.c:10:
    /usr/include/x86_64-linux-gnu/bits/stdint-intn.h:27:19: error: conflict=
ing types for =E2=80=98int64_t=E2=80=99; have =E2=80=98__int64_t=E2=80=
=99 {aka =E2=80=98long long int=E2=80=99}
       27 | typedef __int64_t int64_t;
          |                   ^~~~~~~
    In file included from progs/test_cls_redirect_dynptr.c:6:
    /ci/workspace/bpfgcc.20240922/lib/gcc/bpf-unknown-none/15.0.0/include/s=
tdint.h:43:24: note: previous declaration of =E2=80=98int64_t=E2=80=99 with=
 type =E2=80=98int64_t=E2=80=99 {aka =E2=80=98long int=E2=80=99}
       43 | typedef __INT64_TYPE__ int64_t;
          |                        ^~~~~~~

This is on a typical ubuntu:noble system:

    $ dpkg -s libc6 | grep Version
    Version: 2.39-0ubuntu8.3

I got this with snapshots 15-20241110 and 15-20240922 (the oldest I
tested). This problem may or may not be present in the most recent
versions, I can't tell for sure.

GCC team, please investigate and let me know if you're aware of
workarounds or if there is a specific GCC version that you know is
capable of building BPF programs in selftests/bpf.

If you suspect something might be wrong with the includes for BPF
programs, or GCC snapshot build etc, please also let me know. I mostly
relied on Cupertino scripts when setting that up, and assumed the
selftests/bpf/Makefile is handling BPF_GCC correctly.

Thank you, and happy holidays!

[1] https://github.com/libbpf/ci/pull/164
[2] https://github.com/libbpf/ci/pull/144
[3] https://gist.github.com/theihor/98883c4266b3489cee69e5d5aa532e79
[4] https://github.com/libbpf/ci/actions/runs/12522053128/job/34929897322
[5] https://gist.github.com/theihor/785bb250dd1cce3612e70b5f6d258401
[6] https://gist.github.com/theihor/a8aa7201b30ac6b48df77bb1ea3ec0b2



