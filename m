Return-Path: <bpf-owner@vger.kernel.org>
X-Original-To: lists+bpf@lfdr.de
Delivered-To: lists+bpf@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id B6AD85AC692
	for <lists+bpf@lfdr.de>; Sun,  4 Sep 2022 23:10:58 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230312AbiIDVK4 (ORCPT <rfc822;lists+bpf@lfdr.de>);
        Sun, 4 Sep 2022 17:10:56 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:47164 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229596AbiIDVK4 (ORCPT <rfc822;bpf@vger.kernel.org>);
        Sun, 4 Sep 2022 17:10:56 -0400
Received: from mail-io1-xd41.google.com (mail-io1-xd41.google.com [IPv6:2607:f8b0:4864:20::d41])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 3F786286C3;
        Sun,  4 Sep 2022 14:10:55 -0700 (PDT)
Received: by mail-io1-xd41.google.com with SMTP id z72so5606985iof.12;
        Sun, 04 Sep 2022 14:10:55 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20210112;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:from:to:cc:subject:date;
        bh=J51I8RaCuzdT8Bm/bwvJ5WcPKRZ8WBpgbavhM4XpO+M=;
        b=hzmufDgT5oVB7PkbGKtfLUEKpLN8jhiF7t4rTHyxd6u4n7cFvai2UUTMqxsi02g8Mo
         2LP6nd/B6n82UA3Tv29BFhEaTfoTjUp5nqR2qwLFlW/f5Z6eaEUsNNV5F42cz8ze2n1c
         9zKnQahwia/oOAKw4EzTz+gswVsZZtLA9wincWGyzAA/mLEdP38eThHnvatHvcRpxnIy
         WiKqilQnYCprbB85dAi/sDffTQCKSDh/craYEcoOZajYtrS3BDI+Nj1evrr/HWg45VWZ
         4V7A0tB2bzeN2CyxahKJZu/mI+sHZlabZDJwHdUB4FI88nfU3y94ZSiOGpGfWj7PmN0C
         bJ4Q==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:x-gm-message-state:from:to:cc:subject:date;
        bh=J51I8RaCuzdT8Bm/bwvJ5WcPKRZ8WBpgbavhM4XpO+M=;
        b=v40HQ92O9AENjD9Q5JXaOeN4ABgY3ez9Y4H9UI8666G3PxkXdwcTl73pwGxO1f/ScX
         5jDuGZoq93OLfnqFzZi9YjmkfFO/f5I9fq83BJqo+uGCuU6pngCq6iwybeZhcH7VDgFR
         xDl26pD0ubOagc4ltHjOo6FvJe8BoeU8kxVqU/2DBxoU4pZFuwc02CIWHRZs+SIHjL3X
         tj76ovPpGHdUPbfKXKTYrLU7Np+4MBd2FHcHKa9/WTJ2WXYsrGDCJyKPBdHc20oZ+Oyz
         7qZgQokRLpNSR+jRE5ZmReDsAg3gg87slrQWApo7pt7lDlzMBroFKpRfr6OEl4LdQK7g
         rsyw==
X-Gm-Message-State: ACgBeo0+8VsFWpuqVYAUYFX7kTfgreIDGyB8I3wH1TUQrD2hayGane3G
        0pkejFlGvh1e8xUkUfi79WM+rrWitsAHCaewUZ/t9FhOAfk=
X-Google-Smtp-Source: AA6agR6AywIt7M7No4j2fnJElZWk/VLIDrBPVK5mZaTNsEq1I6Uq8B7FMRTiAPnQeMHuDFxFTEX9CT8IBjljZCtDDjs=
X-Received: by 2002:a5e:dc46:0:b0:689:94f6:fa3e with SMTP id
 s6-20020a5edc46000000b0068994f6fa3emr22214989iop.110.1662325854603; Sun, 04
 Sep 2022 14:10:54 -0700 (PDT)
MIME-Version: 1.0
References: <YxR9v/dyzDt8sBFT@playground>
In-Reply-To: <YxR9v/dyzDt8sBFT@playground>
From:   Kumar Kartikeya Dwivedi <memxor@gmail.com>
Date:   Sun, 4 Sep 2022 23:10:18 +0200
Message-ID: <CAP01T76nG7wQ-WFdjtYr5v-KutAOTRJ_zME-nV6HYUwwYW=z6Q@mail.gmail.com>
Subject: Re: [PATCH bpf-next] Fixes: 14a324f6a67e ("bpf: Wire up freeing of
 referenced kptr")
To:     Jules Irenge <jbi.octave@gmail.com>
Cc:     ast@kernel.org, linux-kernel@vger.kernel.org, bpf@vger.kernel.org,
        daniel@iogearbox.net, martin.lau@linux.dev,
        Elana.Copperman@mobileye.com
Content-Type: text/plain; charset="UTF-8"
X-Spam-Status: No, score=-2.1 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,FREEMAIL_FROM,
        RCVD_IN_DNSWL_NONE,SPF_HELO_NONE,SPF_PASS,T_SCC_BODY_TEXT_LINE
        autolearn=ham autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <bpf.vger.kernel.org>
X-Mailing-List: bpf@vger.kernel.org

On Sun, 4 Sept 2022 at 12:28, Jules Irenge <jbi.octave@gmail.com> wrote:
>
> This patch fixes a warning generated by Sparse
>
> "warning: Using plain integer as NULL pointer"
>
> by replacing p with *p in the WRITE_ONCE() macro
>
> This enables the pointer to be cleared on map value delete,
> hence clearing the warning.
>
> Signed-off-by: Jules Irenge <jbi.octave@gmail.com>
> ---

1. Always bump the version number when resending a patch
2. Fixes: ... tag needs to come before your SoB.
3. The headline can instead be [PATCH bpf-next vN] bpf: Fix resetting
logic for unreferenced kptrs
where N is your version number.
4. Commit message needs more work. Apart from what you have specified
about sparse, it can be:

During the process of fixing this warning, it was discovered that the
current code erroneously writes to the pointer variable instead
dereferencing and writing to the actual kptr. Hence, the sparse tool
accidently helped tp uncover this problem. Fix this by doing
WRITE_ONCE(*p, 0) instead of WRITE_ONCE(p, 0). Note that the effect of
this bug is that unreferenced kptrs won't be cleared during
check_and_free_fields. It is not a problem if the clearing is not done
during map_free stage, as there is nothing to free for them.

5. There is no requirement to Cc linux-kernel ML for BPF patches.

>  kernel/bpf/syscall.c | 2 +-
>  1 file changed, 1 insertion(+), 1 deletion(-)
>
> diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.c
> index 27760627370d..f798acd43a28 100644
> --- a/kernel/bpf/syscall.c
> +++ b/kernel/bpf/syscall.c
> @@ -598,7 +598,7 @@ void bpf_map_free_kptrs(struct bpf_map *map, void *map_value)
>                 if (off_desc->type == BPF_KPTR_UNREF) {
>                         u64 *p = (u64 *)btf_id_ptr;
>
> -                       WRITE_ONCE(p, 0);
> +                       WRITE_ONCE(*p, 0);
>                         continue;
>                 }
>                 old_ptr = xchg(btf_id_ptr, 0);
> --
> 2.35.1
>
